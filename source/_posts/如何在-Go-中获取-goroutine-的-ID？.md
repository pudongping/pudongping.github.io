---
title: å¦‚ä½•åœ¨ Go ä¸­è·å– goroutine çš„ IDï¼Ÿ
author: Alex
top: false
hide: false
cover: false
toc: true
mathjax: false
categories: Go
tags:
  - Go
  - Golang
abbrlink: 2dcc2ce
date: 2025-06-12 10:31:29
img:
coverImg:
password:
summary:
---

åœ¨ä½¿ç”¨ Go è¯­è¨€è¿›è¡Œå¹¶å‘ç¼–ç¨‹æ—¶ï¼ŒGoroutine æ˜¯ä¸€ç§è½»é‡çº§çº¿ç¨‹ï¼Œå…·æœ‰å¾ˆé«˜çš„æ€§èƒ½ä¼˜åŠ¿ã€‚ç„¶è€Œï¼ŒGo è¯­è¨€**å¹¶æœªç›´æ¥æä¾›**è·å– Goroutine ID çš„å®˜æ–¹ APIã€‚è¿™æ˜¯ Go è¯­è¨€è®¾è®¡çš„ä¸€éƒ¨åˆ†ï¼Œç›®çš„æ˜¯é¿å…å¼€å‘è€…ä¾èµ– Goroutine ID è¿›è¡Œä¸å¿…è¦çš„å¤æ‚æ“ä½œã€‚ç„¶è€Œï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè·å– Goroutine ID å¯èƒ½ä¼šæœ‰åŠ©äºè°ƒè¯•å’Œæ—¥å¿—è·Ÿè¸ªã€‚

æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»åœ¨ Go è¯­è¨€ä¸­è·å– Goroutine ID çš„å‡ ç§æ–¹æ³•ã€‚

---

## ä¸ºä»€ä¹ˆéœ€è¦ Goroutine IDï¼Ÿ

åœ¨è°ƒè¯•å¹¶å‘ç¨‹åºæ—¶ï¼Œäº†è§£æŸæ®µä»£ç æ˜¯ç”±å“ªä¸ª Goroutine æ‰§è¡Œçš„ï¼Œæœ‰åŠ©äºï¼š
- **è°ƒè¯•é—®é¢˜**ï¼šæ¸…æ¥šåœ°çŸ¥é“é—®é¢˜æ¥æºã€‚
- **æ—¥å¿—è¿½è¸ª**ï¼šåŒºåˆ†ä¸åŒ Goroutine çš„æ‰§è¡Œè¿‡ç¨‹ã€‚
- **æ€§èƒ½åˆ†æ**ï¼šç†è§£å¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µã€‚

è™½ç„¶è¿™äº›éœ€æ±‚åˆç†ï¼Œä½† Go è¯­è¨€å¸Œæœ›å¼€å‘è€…æ›´ä¸“æ³¨äº Goroutine çš„é€»è¾‘è€Œéå®ƒçš„æ ‡è¯†ã€‚å› æ­¤ï¼Œå®˜æ–¹å¹¶æœªç›´æ¥æä¾›è·å– Goroutine ID çš„åŠŸèƒ½ã€‚

---

## è·å– Goroutine ID çš„å®ç°åŸç†

å…¶å® Go çš„æ¯ä¸ª Goroutine éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œå­˜å‚¨åœ¨å…¶è¿è¡Œæ—¶çš„å†…éƒ¨ç»“æ„ä¸­ã€‚è¿™ä¸ª ID ä¸ç›´æ¥å¯¹å¤–æš´éœ²ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡é—´æ¥æ‰‹æ®µè·å–ã€‚

Go çš„è¿è¡Œæ—¶åŒ… `runtime` æä¾›äº†ä¸€äº›å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬äº†è§£ Goroutine çš„çŠ¶æ€ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯ `runtime.Stack`ã€‚

`runtime.Stack` å¯ä»¥ç”Ÿæˆå½“å‰ Goroutine çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸­åŒ…å«äº† Goroutine çš„ IDã€‚é€šè¿‡è§£æè°ƒç”¨æ ˆçš„å†…å®¹ï¼Œå°±èƒ½æå–å‡º Goroutine çš„ IDã€‚

---

## è·å– Goroutine ID

ä»¥ä¸‹æ˜¯ä¸€ä¸ªè·å–å½“å‰ Goroutine ID çš„ç®€å•å®ç°ï¼š

```go
package main

import (
	"bytes"
	"fmt"
	"runtime"
	"strconv"
)

// GetGoroutineID è¿”å›å½“å‰ Goroutine çš„ ID
// é€šè¿‡ runtime.Stack è·å–å½“å‰ Goroutine çš„æ ˆä¿¡æ¯ï¼Œç„¶åæå–å‡º Goroutine ID
// è¿™ç§æ–¹å¼å¯ä»¥è·å–åˆ°å½“å‰ Goroutine çš„ IDï¼Œä½†æ˜¯æ€§èƒ½è¾ƒå·®
func GetGoroutineID() uint64 {
	var buf [64]byte
	// runtime.Stack(buf[:], false) ä¼šå°†å½“å‰ Goroutine çš„æ ˆä¿¡æ¯å†™å…¥ buf ä¸­
	// ç¬¬äºŒä¸ªå‚æ•°æ˜¯ false è¡¨ç¤ºåªè·å–å½“å‰ Goroutine çš„æ ˆä¿¡æ¯ï¼Œå¦‚æœä¸º true åˆ™ä¼šè·å–æ‰€æœ‰ Goroutine çš„æ ˆä¿¡æ¯
	n := runtime.Stack(buf[:], false)
	stack := string(buf[:n])
	// fmt.Println("========")
	// fmt.Println(stack)
	// fmt.Println()
	// stack æ ·ä¾‹: "goroutine 7 [running]:\n..."
	// æå– goroutine åé¢çš„æ•°å­—
	fields := bytes.Fields([]byte(stack))
	id, err := strconv.ParseUint(string(fields[1]), 10, 64)
	if err != nil {
		panic(fmt.Sprintf("æ— æ³•è§£æ Goroutine ID: %v", err))
	}
	return id
}

func main() {
	fmt.Printf("Main Goroutine ID: %d\n", GetGoroutineID())

	var wg sync.WaitGroup
	for i := 0; i < 10; i++ {
		i := i
		wg.Add(1)
		go func() {
			defer wg.Done()
			fmt.Printf("Child [%d] Goroutine ID: [%d]\n", i, GetGoroutineID())
		}()
	}

	wg.Wait()
}
```

---

### ä»£ç è§£æ

1. **`runtime.Stack` è·å–è°ƒç”¨æ ˆ**  
   `runtime.Stack` ä¼šè¿”å›å½“å‰ Goroutine çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬ Goroutine çš„ IDã€‚

2. **è§£æ Goroutine ID**  
   è°ƒç”¨æ ˆä¿¡æ¯æ˜¯å­—ç¬¦ä¸²å½¢å¼ï¼Œä¾‹å¦‚ï¼š
   ```
   goroutine 7 [running]:
   ```
   æˆ‘ä»¬åªéœ€æå– `goroutine` åé¢çš„æ•°å­—ï¼Œå³å¯è·å– IDã€‚

3. **ç±»å‹è½¬æ¢**  
   ä½¿ç”¨ `strconv.ParseUint` å°†å­—ç¬¦ä¸² ID è½¬æ¢ä¸ºæ•°å€¼ç±»å‹ï¼Œä¾¿äºåç»­æ“ä½œã€‚

4. **ä¸» Goroutine ä¸å­ Goroutine çš„å¯¹æ¯”**  
   åœ¨ `main` å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«æ‰“å°ä¸» Goroutine å’Œå­ Goroutine çš„ IDï¼Œä»¥è§‚å¯Ÿå®ƒä»¬çš„ä¸åŒã€‚

---

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**  
   ä½¿ç”¨ `runtime.Stack` è·å– Goroutine ID çš„ä»£ä»·ç›¸å¯¹è¾ƒé«˜ï¼Œä»…é€‚ç”¨äºè°ƒè¯•æˆ–æ—¥å¿—åœºæ™¯ï¼Œä¸å»ºè®®åœ¨æ€§èƒ½æ•æ„Ÿçš„ä»£ç ä¸­é¢‘ç¹ä½¿ç”¨ã€‚

2. **ä¸ä¾èµ– ID è¿›è¡Œä¸šåŠ¡é€»è¾‘**  
   Goroutine ID æ˜¯ä¸€ä¸ªå†…éƒ¨å®ç°ç»†èŠ‚ï¼Œä¸åº”åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ä¾èµ–å®ƒï¼Œä¾‹å¦‚ç”¨äºé”å®šèµ„æºæˆ–åŒæ­¥ä»»åŠ¡ã€‚Go é¼“åŠ±ä½¿ç”¨é€šé“ï¼ˆchannelï¼‰ç­‰é«˜çº§å¹¶å‘åŸè¯­æ¥ç®¡ç†ä»»åŠ¡ã€‚

æ—¢ç„¶ä½¿ç”¨ `runtime.Stack` å…ˆè·å–å †æ ˆä¿¡æ¯çš„æ–¹å¼è·å– Goroutine ID æ€§èƒ½ä¸é«˜ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰æ›´åŠ é«˜æ•ˆçš„æ–¹å¼å‘¢ï¼Ÿ

## ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…é«˜æ•ˆè·å–

æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç¬¬ä¸‰æ–¹åŒ… `github.com/petermattis/goid` æ¥é«˜æ•ˆçš„è·å–å½“å‰ goroutine çš„ ID

é¦–å…ˆæˆ‘ä»¬å…ˆå®‰è£…è¿™ä¸ªåŒ…

```bash
go get -u github.com/petermattis/goid
```

è¿™ä¸ªåŒ…ä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥

```go
// goid åº“ä½¿ç”¨äº† C å’Œ æ±‡ç¼–æ¥è·å– Goroutine IDï¼Œæ€§èƒ½æ›´å¥½
func GetGoroutineID1() int64 {
	id := goid.Get()
	return id
}
```

`goid` åº“ä½¿ç”¨äº† C å’Œæ±‡ç¼–æ¥è·å– goroutine IDï¼Œæ‰€ä»¥æ€§èƒ½æ›´å¥½ã€‚å¹¶ä¸” `goid` å¯¹å¤šä¸ª go ç‰ˆæœ¬åšäº†å…¼å®¹ï¼Œè€Œä¸”ä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ `https://github.com/petermattis/goid/blob/master/goid.go` ä¹Ÿå¯ä»¥å‘ç°æä¾›äº†ä¸€ä¸ª Go è¯­è¨€ç‰ˆæœ¬çš„å®ç°ã€‚è¿™ä¸ª Go ç‰ˆæœ¬çš„å®ç°ä¹Ÿæ˜¯é€šè¿‡ä½¿ç”¨ `runtime.Stack()` æ¥å®ç°çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çœŸçš„éœ€è¦è·å– goroutine IDï¼Œé‚£ä¹ˆè¿˜æ˜¯æ¯”è¾ƒæ¨èä½¿ç”¨è¿™ä¸ªåŒ…çš„ã€‚

---

## æ€»ç»“

Goroutine æ˜¯ Go å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œè€Œ Goroutine ID åœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å’Œè°ƒè¯•ä»£ç ã€‚å°½ç®¡ Go å®˜æ–¹æ²¡æœ‰æä¾›ç›´æ¥çš„ APIï¼Œä½†é€šè¿‡ `runtime.Stack`ï¼Œæˆ‘ä»¬å¯ä»¥é—´æ¥è·å–åˆ° Goroutine çš„ IDã€‚ä½†æ˜¯ç”±äºé€šè¿‡ `runtime.Stack` çš„æ–¹å¼å»è·å– Goroutine ID æ€§èƒ½ä¸é«˜ï¼Œå› æ­¤å¦‚æœä½ ç¡®ç¡®å®å®æƒ³è¦è·å– Goroutine ID æ—¶ï¼Œå°±å»ºè®®ä½ ç›´æ¥ä½¿ç”¨ `goid` åŒ…æ¥è·å–ã€‚

ç„¶è€Œï¼Œè·å– ID åº”ä»…é™äºè°ƒè¯•åœºæ™¯ï¼Œåœ¨å®é™…å¼€å‘ä¸­æ›´åº”å…³æ³¨ Goroutine çš„è¡Œä¸ºå’Œé€šé“é€šä¿¡ã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©æ‚¨åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­æ›´å¥½åœ°æŒæ¡ Goroutine çš„ä½¿ç”¨ï¼å¦‚æœæœ‰ä»»ä½•ç–‘é—®æˆ–å…¶ä»–ä¸»é¢˜æƒ³äº†è§£ï¼Œæ¬¢è¿ç•™è¨€è®¨è®º ğŸ˜Šï¼