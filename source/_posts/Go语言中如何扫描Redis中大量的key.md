---
title: Goè¯­è¨€ä¸­å¦‚ä½•æ‰«æRedisä¸­å¤§é‡çš„key
author: Alex
top: false
hide: false
cover: false
toc: true
mathjax: false
categories: Go
tags:
  - Go
  - Golang
  - Redis
abbrlink: 9b127c3
date: 2024-08-16 22:16:56
img:
coverImg:
password:
summary:
---

åœ¨ Redis ä¸­ï¼Œå½“æˆ‘ä»¬éœ€è¦éå†å¤§é‡çš„é”®æ—¶ï¼Œç›´æ¥ä½¿ç”¨ `KEYS` å‘½ä»¤ä¼šé¢ä¸´æ€§èƒ½ç“¶é¢ˆï¼Œå°¤å…¶æ˜¯åœ¨é”®æ•°é‡éå¸¸å¤šçš„æƒ…å†µä¸‹ã€‚

`KEYS` å‘½ä»¤ä¼šä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰åŒ¹é…çš„é”®ï¼Œè¿™å¯èƒ½å¯¼è‡´ Redis é˜»å¡ï¼Œä¸¥é‡å½±å“çº¿ä¸ŠæœåŠ¡çš„ç¨³å®šæ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis æä¾›äº† `SCAN` å‘½ä»¤ï¼Œç”¨äºåˆ†æ‰¹æ¬¡è¿­ä»£é”®ï¼Œé¿å…ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸¤ä¸ªç¤ºä¾‹ä»£ç ï¼Œè¯¦ç»†è®²è§£å¦‚ä½•åœ¨ Go è¯­è¨€ä¸­ä½¿ç”¨ `SCAN` å‘½ä»¤éå† Redis é”®ã€‚

è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°çš„æ˜¯ `github.com/go-redis/redis` åŒ…ï¼Œå…ˆåˆ›å»ºä¸€ä¸ª redis é“¾æ¥

```go
package redis_demo

import (
	"github.com/go-redis/redis"
)

func RDBClient() (*redis.Client, error) {
	// åˆ›å»ºä¸€ä¸ª Redis å®¢æˆ·ç«¯
	// ä¹Ÿå¯ä»¥ä½¿ç”¨æ•°æ®æºåç§°ï¼ˆDSNï¼‰æ¥åˆ›å»º
	// redis://<user>:<pass>@localhost:6379/<db>
	opt, err := redis.ParseURL("redis://localhost:6379/0")
	if err != nil {
		return nil, err
	}
	client := redis.NewClient(opt)

	// é€šè¿‡ cient.Ping() æ¥æ£€æŸ¥æ˜¯å¦æˆåŠŸè¿æ¥åˆ°äº† redis æœåŠ¡å™¨
	_, err = client.Ping().Result()
	if err != nil {
		return nil, err
	}

	return client, nil
}
```

## ä»£ç ç¤ºä¾‹ 1ï¼šä½¿ç”¨ `SCAN` å‘½ä»¤çš„åŸºæœ¬è¿­ä»£æ–¹å¼

é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œè¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ `SCAN` å‘½ä»¤éå† Redis æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®ã€‚

```go
package redis_demo

import (
	"fmt"
)

func scanKeysDemo1() {
	var cursor uint64
	rdb, err := RDBClient()
	if err != nil {
		panic(err)
	}

	for {
		var keys []string
		var err error
		// Scan å‘½ä»¤ç”¨äºè¿­ä»£æ•°æ®åº“ä¸­çš„æ•°æ®åº“é”®ã€‚
		keys, cursor, err = rdb.Scan(cursor, "*", 0).Result()
		if err != nil {
			panic(err)
		}

		// å¤„ç† keys
		for _, key := range keys {
			fmt.Printf("key: %s\n", key)
		}

		// å¦‚æœ cursor ä¸º 0ï¼Œè¯´æ˜å·²ç»éå†å®Œæˆï¼Œé€€å‡ºå¾ªç¯
		if cursor == 0 {
			break
		}
	}

}
```

### ä»£ç è¯¦è§£ï¼š

1. **RDBClient() å‡½æ•°**: è¿™æ®µä»£ç å‡è®¾ `RDBClient()` æ˜¯ä¸€ä¸ªè¿”å› Redis å®¢æˆ·ç«¯å®ä¾‹çš„å‡½æ•°ï¼Œç”¨äºè¿æ¥ Redis æ•°æ®åº“ã€‚å¦‚æœè¿æ¥å¤±è´¥ï¼Œç¨‹åºä¼šç›´æ¥ panic ç»ˆæ­¢ã€‚

2. **Scan å‘½ä»¤**: `rdb.Scan(cursor, "*", 0).Result()` æ˜¯ `SCAN` å‘½ä»¤çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚è¿™é‡Œçš„ `cursor` ç”¨äºè®°å½•å½“å‰æ‰«æçš„æ¸¸æ ‡ä½ç½®ï¼Œ`*` è¡¨ç¤ºåŒ¹é…æ‰€æœ‰é”®ï¼Œ`0` è¡¨ç¤ºæ¯æ¬¡æ‰«æè¿”å›æ‰€æœ‰åŒ¹é…é”®ã€‚åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œ`cursor` å¿…é¡»ä¸º `0`ï¼Œä¹‹å Redis ä¼šè¿”å›æ–°çš„ `cursor`ï¼Œç›´åˆ° `cursor` å†æ¬¡ä¸º `0` è¡¨ç¤ºè¿­ä»£ç»“æŸã€‚

3. **å¾ªç¯æ‰«æ**: ä½¿ç”¨ `for` å¾ªç¯ä¸æ–­è°ƒç”¨ `SCAN` å‘½ä»¤ï¼Œæ¯æ¬¡è¿”å›ä¸€æ‰¹é”®å¹¶æ›´æ–° `cursor`ã€‚å½“ `cursor` ä¸º `0` æ—¶ï¼Œé€€å‡ºå¾ªç¯ã€‚

4. **é”®å¤„ç†**: `for _, key := range keys` ç”¨äºéå†å½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰é”®ï¼Œå¹¶å¯¹æ¯ä¸ªé”®è¿›è¡Œå¤„ç†ï¼ˆå¦‚æ‰“å°å‡ºæ¥ï¼‰ã€‚

è¿™ä¸ªæ–¹æ³•ç›¸å¯¹ç›´è§‚ï¼Œä½†å¦‚æœ Redis ä¸­çš„é”®æ•°é‡å·¨å¤§ï¼Œæ‰‹åŠ¨å¤„ç†æ¸¸æ ‡çš„æ–¹å¼å¯èƒ½æ˜¾å¾—ç¹çã€‚è¿™æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´ç®€ä¾¿çš„ `Iterator` æ–¹æ³•ã€‚

## ä»£ç ç¤ºä¾‹ 2ï¼šä½¿ç”¨ `Iterator` ç®€åŒ–è¿­ä»£è¿‡ç¨‹

æ¥ä¸‹æ¥æ˜¯ç¬¬äºŒä¸ªç¤ºä¾‹ä»£ç ï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `Iterator` æ–¹æ³•ç®€åŒ–é”®çš„éå†è¿‡ç¨‹ã€‚

```go
package redis_demo

import (
	"fmt"
)

func scanKeysDemo2() {
	rdb, err := RDBClient()
	if err != nil {
		panic(err)
	}

	// é’ˆå¯¹è¿™ç§éœ€è¦éå†å¤§é‡ key çš„åœºæ™¯ï¼Œgo-redis æä¾›äº†ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³• Iterator
	iter := rdb.Scan(0, "*", 50).Iterator()
	for iter.Next() {
		fmt.Printf("key: %s\n", iter.Val())
	}
	if err := iter.Err(); err != nil {
		panic(err)
	}

	// æ­¤å¤–ï¼Œå¯¹äº redis ä¸­çš„ setã€hashã€zset ç­‰ç±»å‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Iterator è¿›è¡Œéå†
	// ä¾‹å¦‚ï¼š
	// iter := rdb.SScan("set_key", 0, "*", 50).Iterator()
	// iter := rdb.HScan("hash_key", 0, "*", 50).Iterator()
	// iter := rdb.ZScan("zset_key", 0, "*", 50).Iterator()
}
```

### ä»£ç è¯¦è§£ï¼š

1. **ä½¿ç”¨ Iterator**: ä¸å‰ä¸€ä¸ªç¤ºä¾‹ä¸åŒï¼Œè¿™é‡Œä½¿ç”¨äº† `Iterator` è¿­ä»£å™¨ã€‚`rdb.Scan(0, "*", 50).Iterator()` åˆ›å»ºäº†ä¸€ä¸ªè¿­ä»£å™¨ï¼Œæ¯æ¬¡è¿”å› 50 ä¸ªåŒ¹é…çš„é”®ã€‚è¿™æ ·æ— éœ€æ‰‹åŠ¨å¤„ç† `cursor`ï¼Œç®€åŒ–äº†éå†è¿‡ç¨‹ã€‚

2. **è¿­ä»£ä¸å¤„ç†**: `for iter.Next()` æ˜¯ä¸€ä¸ªç®€æ´çš„å¾ªç¯ï¼Œç”¨äºéå†æ‰€æœ‰åŒ¹é…çš„é”®ã€‚å½“ `iter.Next()` è¿”å› `false` æ—¶ï¼Œè¡¨ç¤ºéå†ç»“æŸã€‚`iter.Val()` è¿”å›å½“å‰é”®çš„å€¼ã€‚

3. **é”™è¯¯å¤„ç†**: åœ¨å¾ªç¯ç»“æŸåï¼Œæ£€æŸ¥ `iter.Err()` æ˜¯å¦ä¸º `nil`ï¼Œä»¥ç¡®ä¿éå†è¿‡ç¨‹ä¸­æ²¡æœ‰å‡ºç°é”™è¯¯ã€‚

4. **æ‰©å±•åŠŸèƒ½**: æ­¤å¤–ï¼Œ`Iterator` æ–¹æ³•ä¸ä»…é€‚ç”¨äºéå†é”®ï¼Œä¹Ÿå¯ç”¨äºéå† Redis ä¸­çš„é›†åˆï¼ˆ`Set`ï¼‰ã€å“ˆå¸Œï¼ˆ`Hash`ï¼‰ã€æœ‰åºé›†åˆï¼ˆ`ZSet`ï¼‰ç­‰æ•°æ®ç»“æ„ã€‚é€šè¿‡å°† `Scan` æ¢æˆ `SScan`ã€`HScan` æˆ– `ZScan`ï¼Œå°±èƒ½éå†å¯¹åº”çš„æ•°æ®ç»“æ„ã€‚

## æ€»ç»“

è¿™ç¯‡æ–‡ç« ä»‹ç»äº†å¦‚ä½•åœ¨ Go è¯­è¨€ä¸­ä½¿ç”¨ `SCAN` å‘½ä»¤éå† Redis é”®ï¼Œå¹¶æ¯”è¾ƒäº†æ‰‹åŠ¨å¤„ç† `cursor` å’Œä½¿ç”¨ `Iterator` çš„ä¸¤ç§æ–¹å¼ã€‚å¯¹äº Redis æ–°æ‰‹æ¥è¯´ï¼Œäº†è§£ `SCAN` å‘½ä»¤çš„ç”¨æ³•éå¸¸é‡è¦ï¼Œå®ƒä¸ä»…å¸®åŠ©ä½ é¿å…äº†ä½¿ç”¨ `KEYS` å‘½ä»¤å¯èƒ½å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œè¿˜è®©ä½ èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°éå† Redis æ•°æ®ã€‚

å¦‚æœä½ è§‰å¾—æ–‡ç« æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµã€è½¬å‘ï¼Œè®©æ›´å¤šäººæŒæ¡ Redis çš„è¿™äº›å®ç”¨æŠ€å·§ï¼ğŸ˜Š